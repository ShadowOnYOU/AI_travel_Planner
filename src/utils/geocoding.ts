/**
 * åœ°ç†ç¼–ç å·¥å…· - å°†åœ°ç‚¹åç§°è½¬æ¢ä¸ºç»çº¬åº¦åæ ‡
 */

export interface GeocodeResult {
  lng: number;
  lat: number;
  formatted_address?: string;
}

export interface CityCoordinates {
  [key: string]: [number, number];
}

// å¸¸ç”¨åŸå¸‚åæ ‡æ•°æ®åº“
export const CITY_COORDINATES: CityCoordinates = {
  // ä¸­å›½ä¸»è¦åŸå¸‚
  'åŒ—äº¬': [116.404, 39.915],
  'ä¸Šæµ·': [121.472, 31.231],
  'å¹¿å·': [113.264, 23.129],
  'æ·±åœ³': [114.057, 22.543],
  'æ­å·': [120.153, 30.287],
  'å—äº¬': [118.767, 32.041],
  'æˆéƒ½': [104.065, 30.659],
  'é‡åº†': [106.504, 29.533],
  'è¥¿å®‰': [108.948, 34.263],
  'æ­¦æ±‰': [114.298, 30.584],
  'å¤©æ´¥': [117.190, 39.125],
  'è‹å·': [120.619, 31.317],
  'å¦é—¨': [118.110, 24.490],
  'é’å²›': [120.355, 36.082],
  'å¤§è¿': [121.618, 38.914],
  'å®æ³¢': [121.549, 29.868],
  'æ— é”¡': [120.301, 31.574],
  'é•¿æ²™': [112.982, 28.194],
  'éƒ‘å·': [113.665, 34.757],
  'æµå—': [117.000, 36.675],
  'ç¦å·': [119.306, 26.075],
  'åˆè‚¥': [117.283, 31.861],
  'æ˜†æ˜': [102.712, 25.040],
  'å—æ˜Œ': [115.892, 28.676],
  'å¤ªåŸ': [112.549, 37.857],
  'çŸ³å®¶åº„': [114.502, 38.045],
  'å“ˆå°”æ»¨': [126.642, 45.756],
  'é•¿æ˜¥': [125.337, 43.817],
  'æ²ˆé˜³': [123.429, 41.796],
  'ä¹Œé²æœ¨é½': [87.617, 43.792],
  'å…°å·': [103.834, 36.061],
  'é“¶å·': [106.278, 38.466],
  'è¥¿å®': [101.778, 36.623],
  'æ‹‰è¨': [91.132, 29.660],
  'å‘¼å’Œæµ©ç‰¹': [111.670, 40.818],
  
  // å›½é™…åŸå¸‚
  'ä¸œäº¬': [139.691, 35.689],
  'å¤§é˜ª': [135.502, 34.694],
  'äº¬éƒ½': [135.768, 35.009],
  'é¦–å°”': [126.978, 37.566],
  'é‡œå±±': [129.075, 35.180],
  'æ›¼è°·': [100.501, 13.756],
  'æ¸…è¿ˆ': [98.979, 18.788],
  'æ–°åŠ å¡': [103.819, 1.352],
  'å‰éš†å¡': [101.686, 3.139],
  'é›…åŠ è¾¾': [106.845, -6.208],
  'é©¬å°¼æ‹‰': [120.984, 14.599],
  'æ²³å†…': [105.804, 21.028],
  'èƒ¡å¿—æ˜å¸‚': [106.660, 10.762],
  'é‡‘è¾¹': [104.916, 11.544],
  'ä»°å…‰': [96.156, 16.806],
  'ä¸‡è±¡': [102.634, 17.975],
  
  // æ¬§ç¾åŸå¸‚
  'ä¼¦æ•¦': [-0.118, 51.509],
  'å·´é»': [2.349, 48.853],
  'ç½—é©¬': [12.496, 41.902],
  'æŸæ—': [13.405, 52.520],
  'é©¬å¾·é‡Œ': [-3.704, 40.416],
  'é˜¿å§†æ–¯ç‰¹ä¸¹': [4.904, 52.367],
  'ç»´ä¹Ÿçº³': [16.372, 48.207],
  'å¸ƒæ‹‰æ ¼': [14.418, 50.088],
  'çº½çº¦': [-74.006, 40.713],
  'æ´›æ‰çŸ¶': [-118.244, 34.052],
  'èŠåŠ å“¥': [-87.623, 41.881],
  'æ—§é‡‘å±±': [-122.420, 37.775],
  'è¥¿é›…å›¾': [-122.335, 47.608],
  'æ‹‰æ–¯ç»´åŠ æ–¯': [-115.140, 36.171],
  'è¿ˆé˜¿å¯†': [-80.191, 25.761],
  'å¤šä¼¦å¤š': [-79.347, 43.651],
  'æ¸©å“¥å': [-123.116, 49.246],
  'æ‚‰å°¼': [151.209, -33.868],
  'å¢¨å°”æœ¬': [144.946, -37.840],
};

// å¸¸è§æ™¯ç‚¹åæ ‡
export const ATTRACTION_COORDINATES: CityCoordinates = {
  // åŒ—äº¬
  'å¤©å®‰é—¨å¹¿åœº': [116.397, 39.909],
  'æ•…å®«åšç‰©é™¢': [116.397, 39.918],
  'é¢å’Œå›­': [116.273, 39.999],
  'å¤©å›å…¬å›­': [116.407, 39.883],
  'åŒ—æµ·å…¬å›­': [116.389, 39.928],
  'æ™¯å±±å…¬å›­': [116.394, 39.928],
  'åœ†æ˜å›­': [116.302, 40.008],
  'å…«è¾¾å²­é•¿åŸ': [116.017, 40.357],
  'æ˜åä¸‰é™µ': [116.220, 40.279],
  'é›å’Œå®«': [116.418, 39.948],
  
  // ä¸Šæµ·
  'å¤–æ»©': [121.490, 31.240],
  'ä¸œæ–¹æ˜ç å¡”': [121.506, 31.240],
  'ä¸Šæµ·è¿ªå£«å°¼': [121.656, 31.144],
  'è±«å›­': [121.492, 31.227],
  'ç”°å­åŠ': [121.466, 31.210],
  'æ–°å¤©åœ°': [121.477, 31.219],
  'ä¸Šæµ·åšç‰©é¦†': [121.475, 31.228],
  'å—äº¬è·¯æ­¥è¡Œè¡—': [121.473, 31.235],
  'é™†å®¶å˜´': [121.505, 31.238],
  
  // æ­å·
  'è¥¿æ¹–': [120.149, 30.259],
  'é›·å³°å¡”': [120.149, 30.231],
  'æ–­æ¡¥æ®‹é›ª': [120.142, 30.264],
  'ä¸‰æ½­å°æœˆ': [120.138, 30.247],
  'èŠ±æ¸¯è§‚é±¼': [120.127, 30.248],
  'çµéšå¯º': [120.101, 30.240],
  'å…­å’Œå¡”': [120.134, 30.199],
  'å®‹åŸ': [120.093, 30.197],
  
  // æˆéƒ½
  'å®½çª„å··å­': [104.055, 30.663],
  'é”¦é‡Œå¤è¡—': [104.047, 30.645],
  'æ­¦ä¾¯ç¥ ': [104.048, 30.645],
  'æœç”«è‰å ‚': [104.025, 30.660],
  'ç†ŠçŒ«åŸºåœ°': [104.147, 30.735],
  'é’åŸå±±': [103.570, 30.900],
  'éƒ½æ±Ÿå °': [103.647, 31.018],
  
  // å¹¿å·
  'å¹¿å·å¡”': [113.319, 23.105],
  'é™ˆå®¶ç¥ ': [113.243, 23.124],
  'æ²™é¢å²›': [113.234, 23.108],
  'é•¿éš†é‡ç”ŸåŠ¨ç‰©å›­': [113.339, 23.000],
  'ç™½äº‘å±±': [113.296, 23.180],
  
  // æ·±åœ³
  'ä¸–ç•Œä¹‹çª—': [113.974, 22.534],
  'æ¬¢ä¹è°·': [114.003, 22.538],
  'å¤§æ¢…æ²™æµ·æ»¨å…¬å›­': [114.310, 22.607],
  'è²èŠ±å±±å…¬å›­': [114.063, 22.556],
  
  // è¥¿å®‰
  'å…µé©¬ä¿‘': [109.273, 34.384],
  'åæ¸…æ± ': [109.212, 34.362],
  'å¤§é›å¡”': [108.964, 34.218],
  'è¥¿å®‰åŸå¢™': [108.946, 34.266],
  'åå±±': [110.085, 34.488],
  'æ³•é—¨å¯º': [107.902, 34.426],
};

/**
 * æ ¹æ®åœ°ç‚¹åç§°è·å–åæ ‡
 */
export function getCoordinatesByName(name: string): GeocodeResult | null {
  // ä¼˜å…ˆåŒ¹é…æ™¯ç‚¹
  for (const [attractionName, coords] of Object.entries(ATTRACTION_COORDINATES)) {
    if (name.includes(attractionName) || attractionName.includes(name)) {
      return {
        lng: coords[0],
        lat: coords[1],
        formatted_address: attractionName
      };
    }
  }
  
  // åŒ¹é…åŸå¸‚
  for (const [cityName, coords] of Object.entries(CITY_COORDINATES)) {
    if (name.includes(cityName) || cityName.includes(name)) {
      return {
        lng: coords[0],
        lat: coords[1],
        formatted_address: cityName
      };
    }
  }
  
  return null;
}

/**
 * æ ¹æ®ç›®çš„åœ°è·å–ä¸­å¿ƒåæ ‡
 */
export function getCenterCoordinates(destination: string): [number, number] {
  const result = getCoordinatesByName(destination);
  if (result) {
    return [result.lng, result.lat];
  }
  
  // é»˜è®¤è¿”å›åŒ—äº¬åæ ‡
  return [116.404, 39.915];
}

/**
 * ä¸ºè¡Œç¨‹é¡¹ç›®ç”ŸæˆçœŸå®çš„åæ ‡
 */
export function generateRealisticCoordinates(
  itemTitle: string, 
  destination: string, 
  baseCoords?: [number, number]
): [number, number] {
  // é¦–å…ˆå°è¯•ç²¾ç¡®åŒ¹é…
  const exactMatch = getCoordinatesByName(itemTitle);
  if (exactMatch) {
    console.log(`ğŸ“ [Geocoding] ç²¾ç¡®åŒ¹é…: ${itemTitle} -> [${exactMatch.lng}, ${exactMatch.lat}]`);
    return [exactMatch.lng, exactMatch.lat];
  }
  
  // ä½¿ç”¨ç›®çš„åœ°çš„åŸºç¡€åæ ‡
  const base = baseCoords || getCenterCoordinates(destination);
  
  // éªŒè¯åŸºç¡€åæ ‡æœ‰æ•ˆæ€§
  if (!Array.isArray(base) || base.length !== 2 || 
      typeof base[0] !== 'number' || typeof base[1] !== 'number' ||
      isNaN(base[0]) || isNaN(base[1])) {
    console.warn(`âš ï¸ [Geocoding] åŸºç¡€åæ ‡æ— æ•ˆ: ${base}, ä½¿ç”¨åŒ—äº¬åæ ‡`);
    return [116.404, 39.915]; // é»˜è®¤åŒ—äº¬åæ ‡
  }
  
  // åœ¨åŸºç¡€åæ ‡é™„è¿‘ç”Ÿæˆéšæœºåç§»ï¼ˆæ¨¡æ‹ŸåŒåŸå†…ä¸åŒåœ°ç‚¹ï¼‰
  const offsetRange = 0.02; // çº¦2å…¬é‡ŒèŒƒå›´ï¼Œå‡å°åç§»é¿å…åæ ‡å¼‚å¸¸
  const offsetLng = (Math.random() - 0.5) * offsetRange;
  const offsetLat = (Math.random() - 0.5) * offsetRange;
  
  const result: [number, number] = [base[0] + offsetLng, base[1] + offsetLat];
  
  console.log(`ğŸ“ [Geocoding] ç”Ÿæˆåæ ‡: ${itemTitle} -> [${result[0].toFixed(6)}, ${result[1].toFixed(6)}] (åŸºäº${destination})`);
  
  return result;
}

/**
 * ä½¿ç”¨é«˜å¾·åœ°å›¾APIè¿›è¡Œåœ°ç†ç¼–ç ï¼ˆéœ€è¦API Keyï¼‰
 */
export async function geocodeWithAMap(address: string, apiKey: string): Promise<GeocodeResult | null> {
  if (!apiKey || apiKey === 'your_amap_api_key') {
    return null;
  }
  
  try {
    const response = await fetch(
      `https://restapi.amap.com/v3/geocode/geo?address=${encodeURIComponent(address)}&key=${apiKey}`
    );
    
    const data = await response.json();
    
    if (data.status === '1' && data.geocodes && data.geocodes.length > 0) {
      const location = data.geocodes[0].location.split(',');
      return {
        lng: parseFloat(location[0]),
        lat: parseFloat(location[1]),
        formatted_address: data.geocodes[0].formatted_address
      };
    }
  } catch (error) {
    console.warn('åœ°ç†ç¼–ç å¤±è´¥:', error);
  }
  
  return null;
}